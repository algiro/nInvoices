version: '3.9'

services:
  postgres:
    image: postgres:17-alpine
    container_name: ninvoices-postgres-dev
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-ninvoices_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me_secure_password_123}
      POSTGRES_DB: ${POSTGRES_DB:-ninvoices_db}
    volumes:
      - ./volumes/postgres:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - ninvoices-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ninvoices_user}"]
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: ninvoices-keycloak-dev
    restart: unless-stopped
    command: start-dev
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/${KEYCLOAK_DB_NAME:-keycloak_db}
      KC_DB_USERNAME: ${POSTGRES_USER:-ninvoices_user}
      KC_DB_PASSWORD: ${POSTGRES_PASSWORD:-change_me_secure_password_123}
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: ${KEYCLOAK_PORT:-8080}
      KC_HTTP_ENABLED: true
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN:-admin}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-change_me_admin_password_456}
    volumes:
      - ./volumes/keycloak:/opt/keycloak/data
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ninvoices-network
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET / HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n' >&3 && timeout 1 cat <&3 | grep -q '200\\|301\\|302' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: ninvoices-api-dev
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_HTTP_PORTS=8080
      - ConnectionStrings__Default=Host=postgres;Port=5432;Database=${POSTGRES_DB:-ninvoices_db};Username=${POSTGRES_USER:-ninvoices_user};Password=${POSTGRES_PASSWORD:-change_me_secure_password_123}
      - Database__Type=PostgreSQL
      - Keycloak__Authority=http://keycloak:8080/realms/${KEYCLOAK_REALM:-ninvoices}
      - Keycloak__Audience=${KEYCLOAK_CLIENT_ID:-ninvoices-api}
      - Keycloak__ValidIssuer=http://keycloak:8080/realms/${KEYCLOAK_REALM:-ninvoices}
      - Cors__Origins=${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173}
    volumes:
      - ./volumes/logs:/app/logs
    ports:
      - "${API_PORT:-5000}:8080"
    depends_on:
      postgres:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    networks:
      - ninvoices-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web
      args:
        VITE_API_URL: ${API_URL:-http://localhost:5000}
        VITE_KEYCLOAK_URL: ${KEYCLOAK_URL:-http://localhost:8080}
        VITE_KEYCLOAK_REALM: ${KEYCLOAK_REALM:-ninvoices}
        VITE_KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-ninvoices-web}
    container_name: ninvoices-web-dev
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3000}:80"
    depends_on:
      - api
    networks:
      - ninvoices-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  ninvoices-network:
    driver: bridge
